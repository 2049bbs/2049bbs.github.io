---
aid: 4109
cid: 3
authorID: 3619
addTime: 2020-04-06T09:00:00.000Z
title: 【2049首发】ESNI细节讲解
tags:
    - '2049'
    - ESNI
    - 讲解
    - 首发
    - 细节
comments:
    -
        authorID: 3619
        addTime: 2020-04-06T09:00:00.000Z
        content: >-
            @[v2rayuser](/member/v2rayuser) 我解释下你的DoH发起的时候，有没有ESNI的问题。


            首先DoH的地址，可以是这样的
            [https://1.1.1.1/dns-query](https://1.1.1.1/dns-query)


            也是可以
            [https://dns.couldflare-dns.com/dns-query](https://dns.couldflare-dns.com/dns-query)
            这样的


            如果是第一种情况，因为是IP地址，自然不存在SNI，也就不可能存在ESNI


            如果是第二种情况，因为是域名，所以要先去查这个域名的具体IP，也就是用传统的DNS查找


            在about:config配置页，输入 network.trr.bootstrapAddress 这个配置后面填入具体的DNS地址


            完整过程就是火狐，先从network.trr.bootstrapAddress
            配置的DNS地址，查找具体的IP，再发起TLS连接。这个时候，没有使用DoH，用的是传统的DNS，所以SNI没有加密


            火狐使用ESNI，必须配合DoH，使用**传统的DNS是无效**的
date: 2020-04-06T09:00:00.000Z
category: 技术
---

先啰嗦一句，估计这是全网唯一一篇**中文**讲解ESNI的文章。其他语言有没有，我就不知道了。

先讲流程和细节：

Q1. SNI被加密了，用的是什么加密算法，加密密钥从哪里来？

A1.使用的加密算法是AEAD，具体是哪种AEAD，是协商出来的。密钥是通过PSK协商出来的。

Q2.如果是通过PSK协商，那么服务器的公钥是从哪里来的？

A2.通过DNS得到，具体来说是DNS的 TXT record。

Q3.发起DoH的时候，SNI有没有加密呢？

A3.没有，原因我下面解释

大致流程：

1.火狐通过DNS over HTTPS 发起 请求 服务器的ip地址，还有txt record

2.如果txt record里有公钥信息，说明服务器支持esni，用这个record协商出了aes的密钥

3.用aes密钥加密sni，拼到clienthello的esni字段

4.发送给服务器
