---
aid: 3857
cid: 3
authorID: 3615
addTime: 2020-03-30T06:45:00.000Z
title: Lisa大神能不能帮忙解释下这两个问题？
tags:
    - Lisa
    - 大神
    - 帮忙
    - 解释
    - 两个
comments:
    -
        authorID: 3676
        addTime: 2020-03-30T09:15:00.000Z
        content: >-
            第二个其实可以做成这样[https://hidester.com/proxy/](https://hidester.com/proxy/)
            做成一个通用的online web proxy，不需要一个一个的网站去做反代。大部分这种online web
            proxy本身就被墙了，但如果配合cdn+doh+esni，就可以像直连pincong那样，通过online web
            proxy去访问各种被墙的网站。
    -
        authorID: 3619
        addTime: 2020-04-06T11:00:00.000Z
        content: |-
            第一个问题

            就是这次GitHub的中间人攻击，原理一模一样。**不建议**使用这个方式，很容易被中间人攻击。

            第二个问题

            反向代理肯定可以，但是GFW可以主动嗅探。你的反向代理服务器马上就会被墙。不可行！
    -
        authorID: 3615
        addTime: 2020-04-06T11:30:00.000Z
        content: >-
            @[立紗Lisa](/member/%E7%AB%8B%E7%B4%97Lisa) #2
            lisa大神，可以说的细一些么？好抽象啊，我不懂


            第一个问题，说是中间人攻击，能不能解释下怎么攻击？第二个问题，主动嗅探是怎么工作的，原理说下？
    -
        authorID: 3619
        addTime: 2020-04-07T11:15:00.000Z
        content: >-
            @[张怀义](/member/%E5%BC%A0%E6%80%80%E4%B9%89) #3


            第一个问题，本地浏览器发起TLS请求，代理软件截获。删掉了SNI，转发给服务器。服务器返回了证书，但是会有告警，代理软件忽略了告警，所以可以上网。也因为忽略了告警，如果出现GitHub那样的伪造的证书，也会被许可，这样就被中间人攻击了。


            第二个问题，GFW会模拟正常的浏览器访问这些反向代理服务器，根据应答报文，就能知道这个是代理服务器了。就是GFW扫描流量，发现可疑TLS连接，就会模拟浏览器去尝试访问。所以v2ray模拟websocket的时候，才会伪造一个网站，因为GFW会自己嗅探
    -
        authorID: 3534
        addTime: 2020-04-07T12:30:00.000Z
        content: '@[立紗Lisa](/member/%E7%AB%8B%E7%B4%97Lisa) #2 证书和密钥都是本地生成的，我觉得没什么问题'
    -
        authorID: 3676
        addTime: 2020-04-07T13:00:00.000Z
        content: >-
            @[立紗Lisa](/member/%E7%AB%8B%E7%B4%97Lisa) #4
            加了DOH+ESNI，主动探测到了也墙不了的。就像现在pincong.rocks一直可以通过这种方式直连一样。
            不过最近GFW似乎把firefox默认的DOH的DNS给墙了，但只要换个DOH的DNS就行了。
            除非GFW再进一步把所有cloudflare的CDN给墙了，或者把ESNI的包都给reset掉，那就是更进一步了。
    -
        authorID: 3619
        addTime: 2020-04-07T13:30:00.000Z
        content: >-
            @[solids](/member/solids) #5


            仅考虑代理软件，代理软件会去向目标网站申请证书。而且没有校验证书是不是有效。


            如果这个时候被GFW中间人攻击，代理软件会忽略，导致中间人攻击。


            [https://github.com/URenko/Accesser/](https://github.com/URenko/Accesser/)
            官网写的 支持python3.7版本


            [https://docs.python.org/3/library/ssl.html](https://docs.python.org/3/library/ssl.html)


            ssl.match\_hostname 这段 Changed in version 3.7: The function is no
            longer used to TLS connections. Hostname matching is now performed
            by OpenSSL.


            同时 Verifying certificates When calling the SSLContext constructor
            directly, CERT\_NONE is the default. Since it does not authenticate
            the other peer, it can be insecure, especially in client mode where
            most of time you would like to ensure the authenticity of the server
            you’re talking to. Therefore, when in client mode, it is highly
            recommended to use CERT\_REQUIRED. However, it is in itself not
            sufficient; you also have to check that the server certificate,
            which can be obtained by calling SSLSocket.getpeercert(), matches
            the desired service. For many protocols and applications, the
            service can be identified by the hostname; in this case, the
            match\_hostname() function can be used. This common check is
            automatically performed when SSLContext.check\_hostname is enabled.


            Changed in version 3.7: Hostname matchings is now performed by
            OpenSSL. Python no longer uses match\_hostname().


            * * *


            然后开始看代码201-204行

                        if self.host in setting.config['alert_hostname']:
                            server_hostname = setting.config['alert_hostname'][self.host]
                        else:
                            server_hostname = None
                

            人话版本：如果代理软件认为域名 在
            [https://github.com/URenko/Accesser/blob/master/template/pac](https://github.com/URenko/Accesser/blob/master/template/pac)
            文件的domains里的话，同时，域名不在[https://github.com/URenko/Accesser/blob/master/config.json.default的alert\_hostname的话，则把SNI信息去除，否则改用](https://github.com/URenko/Accesser/blob/master/config.json.default%E7%9A%84alert_hostname%E7%9A%84%E8%AF%9D%EF%BC%8C%E5%88%99%E6%8A%8ASNI%E4%BF%A1%E6%81%AF%E5%8E%BB%E9%99%A4%EF%BC%8C%E5%90%A6%E5%88%99%E6%94%B9%E7%94%A8)
            json里的域名


            也就是说，代码是删除了SNI信息来完成规避SNI RST，这样GFW伪造一个证书，就可以骗过代理，因为代理不会检查证书
date: 2020-04-07T13:30:00.000Z
category: 技术
---

[https://pincong.rocks/article/17023](https://pincong.rocks/article/17023)

这个是什么原理？

[https://pincong.rocks/question/22222](https://pincong.rocks/question/22222)

这个可行么？
